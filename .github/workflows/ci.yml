name: CI/CD for Trivia App

on:
  push:
    branches:
      - main

jobs:
  update-image-tags:
    name: Update Image Tags
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "github-actions-bot@example.com"

    - name: Update Image Tag for Trivia App
      run: |
        # Define the correct paths to your deployment YAML files
        backend_deployment="trivia-app/k8s/backend-deployment.yaml"
        frontend_deployment="trivia-app/k8s/frontend-deployment.yaml"

        # Ensure the files exist
        if [[ ! -f $backend_deployment ]]; then
          echo "Error: Backend deployment file not found at $backend_deployment"
          exit 1
        fi

        if [[ ! -f $frontend_deployment ]]; then
          echo "Error: Frontend deployment file not found at $frontend_deployment"
          exit 1
        fi

        # Fetch the new image tag
        new_image_tag=${{ github.sha }}

        # Update backend and frontend image tags
        sed -i "s|image: .*trivia-backend:.*|image: trivia-backend:$new_image_tag|" "$backend_deployment"
        sed -i "s|image: .*trivia-frontend:.*|image: trivia-frontend:$new_image_tag|" "$frontend_deployment"

        echo "Updated backend and frontend image tags to $new_image_tag"

    # - name: Commit and Push Changes
    #   run: |
    #     git pull --rebase
    #     git add trivia-app/k8s/*.yaml
    #     git commit -m "Update image tags to ${{ github.sha }}"
    #     git push
        
    - name: Commit the Changes
      run: |
            git config --global user.name 'Kadirvel'
            git config --global user.email 'a.kadirvel@gmail.com'
            git pull --rebase
            git add $backend_deployment $frontend_deployment
            git commit -m "Update image tags to $new_image_tag"
            git push
        